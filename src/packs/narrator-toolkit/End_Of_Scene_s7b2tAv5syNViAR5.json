{
  "name": "End Of Scene",
  "type": "script",
  "scope": "global",
  "author": "U772esq9FbrkahYQ",
  "img": "icons/svg/door-exit.svg",
  "command": "//*Narrator's Toolbox - End of Scene*//\nif (!game.user.isGM) {\n\tui.notifications.warn(\"You must be a Narrator to use this macro.\");\n\treturn;\n}\nlet actors = game.actors.contents.filter((a) => a.type === \"Protagonist\");\nlet arcTitle = actors[0]?.system.Vital.arc.title || \"\";\nlet regressionTitle = actors[0]?.system.entermeta.regression.title || \"\";\nlet dialogContent = `<form>\n<div class=\"style-form\">To be used at the end of each Scene to award Destiny</div>\n<div class=\"style-form\">You can mouse-over the Arc & Regression, for a quick reminder of each<br><br></div>\n<div class=\"form-group style-form\">\n\t<div class=\"style-form\">Protagonist</div>\n\t<div class=\"style-form\" title=\"${arcTitle}\">Arc</div>\n\t<div class=\"style-form\" title=\"${regressionTitle}\">Regression</div>\n\t<div class=\"style-form\">Award Destiny</div>\n</div>\n`;\nfor (let actor of actors) {\n\tlet regressionValue = actor.system.entermeta.regression.value;\n\tlet regressionTitle = actor.system.entermeta.regression.options[regressionValue]?.title || \"This is not an officially supported Regression\";\n\tlet arcValue = actor.system.Vital.arc.value;\n\tlet arcTitle = actor.system.Vital.arc.options[arcValue]?.title || \"This is not an officially supported Arc\";\n\tdialogContent += `<div class=\"form-group style-form\">\n\t\t\t<div class=\"style-form\">${actor.name}</div>\n\t\t\t<div class=\"style-form\" title=\"${arcTitle}\">${arcValue}</div>\n\t\t\t<div class=\"style-form\" title=\"${regressionTitle}\">${regressionValue}</div>\n\t\t\t<div class=\"style-form\"><input type=\"number\" name=\"awardDestiny-${actor.id}\" value=\"1\"></div>\n\t\t\t</div>`;\n}\ndialogContent += `</form><br><br>`;\ndialogContent += `<div class=\"style-form\">Confirming will award Destiny and set Max Destiny accordingly for each Protagonist</div>`;\ndialogContent += `<div class=\"style-form\">Protagonists with Luck Bending will be automatically awarded the extra Destiny</div><br><br>`;\nlet dialogOptions = {\n\twidth: 750,\n\theight: 520,\n\tresizable: true,\n};\nlet toolboxdialog = new Dialog(\n\t{\n\t\ttitle: \"Narrator's Toolbox - End of Scene\",\n\t\tcontent: dialogContent,\n\t\tbuttons: {\n\t\t\tok: {\n\t\t\t\tlabel: \"Confirm\",\n\t\t\t\tcallback: async (html) => {\n\t\t\t\t\tfor (let actor of actors) {\n\t\t\t\t\t\tlet currentDestiny = parseInt(actor.system.Vital.Destiny.value);\n\t\t\t\t\t\tlet awardDestiny = parseInt(html.find(`[name=\"awardDestiny-${actor.id}\"]`).val());\n\t\t\t\t\t\t//? Check for Luck Bending that would affect Destiny awards\n\t\t\t\t\t\tlet extraDestiny = 0;\n\t\t\t\t\t\tlet equippedItems = actor.items.toObject();\n\t\t\t\t\t\tlet equippedMetapowers = equippedItems.filter((item) => item.type === \"Metapower\");\n\t\t\t\t\t\tlet equippedLuck = equippedMetapowers.filter(\n\t\t\t\t\t\t\t(item) => item.system.MetapowerName.value === \"Luck Bending\"\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (equippedLuck.length > 0) {\n\t\t\t\t\t\t\tconst levels = equippedLuck.map((item) => item.system.Level.value);\n\t\t\t\t\t\t\tconst maxLevel = Math.max(...levels);\n\t\t\t\t\t\t\textraDestiny = maxLevel;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet newDestiny = currentDestiny + awardDestiny + extraDestiny;\n\t\t\t\t\t\tlet maxDestiny = newDestiny;\n\t\t\t\t\t\tawait actor.update({\n\t\t\t\t\t\t\t\"system.Vital.Destiny.value\": newDestiny,\n\t\t\t\t\t\t\t\"system.Vital.Destiny.max\": maxDestiny,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tcancel: {\n\t\t\t\tlabel: \"Cancel\",\n\t\t\t},\n\t\t},\n\t\tdefault: \"ok\",\n\t},\n\tdialogOptions\n);\ntoolboxdialog.render(true);",
  "folder": null,
  "ownership": {
    "default": 0,
    "U772esq9FbrkahYQ": 3
  },
  "flags": {
    "advanced-macros": {
      "runForSpecificUser": ""
    },
    "core": {},
    "scene-packer": {
      "sourceId": "Macro.le8tJEXICKaihrKn",
      "hash": "e5b0049a45752f11b37399b7421f9f58a22c97c8"
    }
  },
  "_stats": {
    "systemId": "metanthropes",
    "systemVersion": "0.8.40",
    "coreVersion": "11.313",
    "createdTime": 1693074096201,
    "modifiedTime": 1698678304219,
    "lastModifiedBy": "yg1FtESHVZwL2lLZ"
  },
  "_id": "s7b2tAv5syNViAR5",
  "sort": 0,
  "_key": "!macros!s7b2tAv5syNViAR5"
}
